{
    "version": 3,
    "sources": [
        "../../../src/api/controller/qrcode.js"
    ],
    "names": [
        "Base",
        "require",
        "rp",
        "fs",
        "http",
        "path",
        "module",
        "exports",
        "getBase64Action",
        "goodsId",
        "post",
        "page",
        "sceneData",
        "options",
        "method",
        "url",
        "qs",
        "grant_type",
        "secret",
        "think",
        "config",
        "appid",
        "sessionData",
        "JSON",
        "parse",
        "token",
        "access_token",
        "data",
        "stringify",
        "options2",
        "host",
        "headers",
        "length",
        "uploadFunc",
        "Promise",
        "resolve",
        "reject",
        "req",
        "request",
        "res",
        "setEncoding",
        "imgData",
        "on",
        "chunk",
        "write",
        "end",
        "e",
        "success"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;AACA,MAAMC,KAAKD,QAAQ,iBAAR,CAAX;AACA,MAAME,KAAKF,QAAQ,IAAR,CAAX;AACA,MAAMG,OAAOH,QAAQ,MAAR,CAAb;AACA,MAAMI,OAAOJ,QAAQ,MAAR,CAAb;AACA;AACAK,OAAOC,OAAP,GAAiB,cAAcP,IAAd,CAAmB;AAC1BQ,mBAAN,GAAwB;AAAA;;AAAA;AACpB,gBAAIC,UAAU,MAAKC,IAAL,CAAU,SAAV,CAAd;AACA,gBAAIC,OAAO,mBAAX;AACA,gBAAIC,YAAYH,OAAhB;AACA,kBAAMI,UAAU;AACZC,wBAAQ,MADI;AAEZC,qBAAK,yCAFO;AAGZC,oBAAI;AACAC,gCAAY,mBADZ;AAEAC,4BAAQC,MAAMC,MAAN,CAAa,eAAb,CAFR;AAGAC,2BAAOF,MAAMC,MAAN,CAAa,cAAb;AAHP;AAHQ,aAAhB;AASA,gBAAIE,cAAc,MAAMpB,GAAGW,OAAH,CAAxB;AACAS,0BAAcC,KAAKC,KAAL,CAAWF,WAAX,CAAd;AACA,gBAAIG,QAAQH,YAAYI,YAAxB;AACA,gBAAIC,OAAO;AACP,yBAASf,SADF,EACa;AACpB,wBAAQD,IAFD;AAGP,yBAAS;AAHF,aAAX;AAKAgB,mBAAOJ,KAAKK,SAAL,CAAeD,IAAf,CAAP;AACA,gBAAIE,WAAW;AACXf,wBAAQ,MADG;AAEXgB,sBAAM,mBAFK;AAGXzB,sBAAM,yCAAyCoB,KAHpC;AAIXM,yBAAS;AACL,oCAAgB,kBADX;AAEL,sCAAkBJ,KAAKK;AAFlB;AAJE,aAAf;AASA,kBAAMC;AAAA,6CAAa,aAAY;AAC3B,2BAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACpC,4BAAI;AACA,gCAAIC,MAAMjC,KAAKkC,OAAL,CAAaT,QAAb,EAAuB,UAASU,GAAT,EAAc;AAC3CA,oCAAIC,WAAJ,CAAgB,QAAhB;AACA,oCAAIC,UAAU,EAAd;AACAF,oCAAIG,EAAJ,CAAO,MAAP,EAAe,UAASC,KAAT,EAAgB;AAC3BF,+CAAWE,KAAX;AACH,iCAFD;AAGAJ,oCAAIG,EAAJ,CAAO,KAAP,EAAc,YAAW;AACrB,2CAAOP,QAAQM,OAAR,CAAP;AACH,iCAFD;AAGH,6BATS,CAAV;AAUAJ,gCAAIO,KAAJ,CAAUjB,IAAV;AACAU,gCAAIQ,GAAJ;AACH,yBAbD,CAaE,OAAOC,CAAP,EAAU;AACR,mCAAOX,QAAQ,IAAR,CAAP;AACH;AACJ,qBAjBM,CAAP;AAkBH,iBAnBK;;AAAA;AAAA;AAAA;AAAA,gBAAN;AAoBA,kBAAMpB,MAAM,MAAMkB,YAAlB;AACA,mBAAO,MAAKc,OAAL,CAAahC,GAAb,CAAP;AApDoB;AAqDvB;AAtD+B,CAApC",
    "file": "../../../src/api/controller/qrcode.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst rp = require('request-promise');\nconst fs = require('fs');\nconst http = require(\"http\");\nconst path = require('path');\n// const mineType = require('mime-types');\nmodule.exports = class extends Base {\n    async getBase64Action() {\n        let goodsId = this.post('goodsId');\n        let page = \"pages/goods/goods\";\n        let sceneData = goodsId;\n        const options = {\n            method: 'POST',\n            url: 'https://api.weixin.qq.com/cgi-bin/token',\n            qs: {\n                grant_type: 'client_credential',\n                secret: think.config('weixin.secret'),\n                appid: think.config('weixin.appid')\n            }\n        };\n        let sessionData = await rp(options);\n        sessionData = JSON.parse(sessionData);\n        let token = sessionData.access_token;\n        let data = {\n            \"scene\": sceneData, //第一个参数是抽奖ID，第二个是userId，第三个是share=1\n            \"page\": page,\n            \"width\": 200\n        };\n        data = JSON.stringify(data);\n        var options2 = {\n            method: \"POST\",\n            host: \"api.weixin.qq.com\",\n            path: \"/wxa/getwxacodeunlimit?access_token=\" + token,\n            headers: {\n                \"Content-Type\": \"application/json\",\n                \"Content-Length\": data.length\n            }\n        };\n        const uploadFunc = async () => {\n            return new Promise((resolve, reject) => {\n                try {\n                    var req = http.request(options2, function(res) {\n                        res.setEncoding(\"base64\");\n                        var imgData = \"\";\n                        res.on('data', function(chunk) {\n                            imgData += chunk;\n                        });\n                        res.on(\"end\", function() {\n                            return resolve(imgData);\n                        });\n                    });\n                    req.write(data);\n                    req.end();\n                } catch (e) {\n                    return resolve(null);\n                }\n            })\n        };\n        const url = await uploadFunc();\n        return this.success(url);\n    }\n}"
    ]
}