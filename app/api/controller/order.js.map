{
    "version": 3,
    "sources": [
        "../../../src/api/controller/order.js"
    ],
    "names": [
        "Base",
        "require",
        "moment",
        "rp",
        "fs",
        "http",
        "module",
        "exports",
        "listAction",
        "showType",
        "get",
        "page",
        "size",
        "status",
        "model",
        "getOrderStatus",
        "is_delete",
        "orderList",
        "field",
        "where",
        "user_id",
        "think",
        "userId",
        "order_type",
        "order_status",
        "order",
        "countSelect",
        "newOrderList",
        "item",
        "data",
        "goodsList",
        "order_id",
        "id",
        "select",
        "goodsCount",
        "forEach",
        "v",
        "number",
        "add_time",
        "unix",
        "getOrderAddTime",
        "format",
        "order_status_text",
        "getOrderStatusText",
        "handleOption",
        "getOrderHandleOption",
        "push",
        "success",
        "countAction",
        "allCount",
        "count",
        "orderCountAction",
        "toPay",
        "toDelivery",
        "toReceive",
        "newStatus",
        "detailAction",
        "orderId",
        "orderInfo",
        "find",
        "currentTime",
        "parseInt",
        "Date",
        "getTime",
        "isEmpty",
        "fail",
        "province_name",
        "province",
        "getField",
        "city_name",
        "city",
        "district_name",
        "district",
        "full_region",
        "postscript",
        "Buffer",
        "from",
        "toString",
        "orderGoods",
        "gitem",
        "confirm_time",
        "dealdone_time",
        "pay_time",
        "shipping_time",
        "confirm_remainTime",
        "final_pay_time",
        "updateInfo",
        "update",
        "textCode",
        "getOrderTextCode",
        "orderGoodsAction",
        "cartList",
        "checked",
        "is_fast",
        "cancelAction",
        "post",
        "cancel",
        "goodsInfo",
        "goods_id",
        "product_id",
        "increment",
        "succesInfo",
        "deleteAction",
        "delete",
        "orderDeleteById",
        "confirmAction",
        "confirm",
        "completeAction",
        "submitAction",
        "addressId",
        "freightPrice",
        "offlinePay",
        "buffer",
        "checkedAddress",
        "checkedGoodsList",
        "checkPrice",
        "checkStock",
        "product",
        "goods_number",
        "retail_price",
        "add_price",
        "goodsTotalPrice",
        "cartItem",
        "orderTotalPrice",
        "actualPrice",
        "print_info",
        "i",
        "Number",
        "goods_aka",
        "def",
        "sender_name",
        "Name",
        "sender_mobile",
        "Tel",
        "userInfo",
        "order_sn",
        "generateOrderNumber",
        "consignee",
        "name",
        "mobile",
        "province_id",
        "city_id",
        "district_id",
        "address",
        "freight_price",
        "goods_price",
        "order_price",
        "actual_price",
        "change_price",
        "offline_pay",
        "add",
        "orderGoodsData",
        "goodsItem",
        "goods_name",
        "list_pic_url",
        "goods_specifition_name_value",
        "goods_specifition_ids",
        "addMany",
        "clearBuyGoods",
        "updateAction",
        "updateAddress",
        "expressAction",
        "info",
        "expressInfo",
        "updateTime",
        "update_time",
        "com",
        "is_finish",
        "shipperCode",
        "shipper_code",
        "expressNo",
        "logistic_code",
        "code",
        "substring",
        "shipperName",
        "lastExpressInfo",
        "getExpressInfo",
        "deliverystatus",
        "newUpdateTime",
        "getDeliverystatus",
        "issign",
        "traces",
        "list",
        "JSON",
        "stringify",
        "dataInfo",
        "express_status",
        "express",
        "options",
        "method",
        "url",
        "headers",
        "sessionData",
        "parse",
        "result",
        "getExpressInfoAction"
    ],
    "mappings": ";;AAAA,MAAMA,OAAOC,QAAQ,WAAR,CAAb;AACA,MAAMC,SAASD,QAAQ,QAAR,CAAf;AACA,MAAME,KAAKF,QAAQ,iBAAR,CAAX;AACA,MAAMG,KAAKH,QAAQ,IAAR,CAAX;AACA,MAAMI,OAAOJ,QAAQ,MAAR,CAAb;AACAK,OAAOC,OAAP,GAAiB,cAAcP,IAAd,CAAmB;AAChC;;;;AAIMQ,cAAN,GAAmB;AAAA;;AAAA;AACf,kBAAMC,WAAW,MAAKC,GAAL,CAAS,UAAT,CAAjB;AACA,kBAAMC,OAAO,MAAKD,GAAL,CAAS,MAAT,CAAb;AACA,kBAAME,OAAO,MAAKF,GAAL,CAAS,MAAT,CAAb;AACA,gBAAIG,SAAS,EAAb;AACAA,qBAAS,MAAM,MAAKC,KAAL,CAAW,OAAX,EAAoBC,cAApB,CAAmCN,QAAnC,CAAf;AACA,gBAAIO,YAAY,CAAhB;AACA;AACA,kBAAMC,YAAY,MAAM,MAAKH,KAAL,CAAW,OAAX,EAAoBI,KAApB,CAA0B,oDAA1B,EAAgFC,KAAhF,CAAsF;AAC1GC,yBAASC,MAAMC,MAD2F;AAE1GN,2BAAWA,SAF+F;AAG1GO,4BAAY,CAAC,GAAD,EAAM,CAAN,CAH8F;AAI1GC,8BAAc,CAAC,IAAD,EAAOX,MAAP;AAJ4F,aAAtF,EAKrBF,IALqB,CAKhBA,IALgB,EAKVC,IALU,EAKJa,KALI,CAKE,eALF,EAKmBC,WALnB,EAAxB;AAMA,kBAAMC,eAAe,EAArB;AACA,iBAAK,MAAMC,IAAX,IAAmBX,UAAUY,IAA7B,EAAmC;AAC/B;AACAD,qBAAKE,SAAL,GAAiB,MAAM,MAAKhB,KAAL,CAAW,aAAX,EAA0BI,KAA1B,CAAgC,wBAAhC,EAA0DC,KAA1D,CAAgE;AACnFC,6BAASC,MAAMC,MADoE;AAEnFS,8BAAUH,KAAKI,EAFoE;AAGnFhB,+BAAW;AAHwE,iBAAhE,EAIpBiB,MAJoB,EAAvB;AAKAL,qBAAKM,UAAL,GAAkB,CAAlB;AACAN,qBAAKE,SAAL,CAAeK,OAAf,CAAuB,aAAK;AACxBP,yBAAKM,UAAL,IAAmBE,EAAEC,MAArB;AACH,iBAFD;AAGAT,qBAAKU,QAAL,GAAgBpC,OAAOqC,IAAP,EAAY,MAAM,MAAKzB,KAAL,CAAW,OAAX,EAAoB0B,eAApB,CAAoCZ,KAAKI,EAAzC,CAAlB,GAAgES,MAAhE,CAAuE,qBAAvE,CAAhB;AACA;AACA;AACA;AACAb,qBAAKc,iBAAL,GAAyB,MAAM,MAAK5B,KAAL,CAAW,OAAX,EAAoB6B,kBAApB,CAAuCf,KAAKI,EAA5C,CAA/B;AACA;AACAJ,qBAAKgB,YAAL,GAAoB,MAAM,MAAK9B,KAAL,CAAW,OAAX,EAAoB+B,oBAApB,CAAyCjB,KAAKI,EAA9C,CAA1B;AACAL,6BAAamB,IAAb,CAAkBlB,IAAlB;AACH;AACDX,sBAAUY,IAAV,GAAiBF,YAAjB;AACA,mBAAO,MAAKoB,OAAL,CAAa9B,SAAb,CAAP;AApCe;AAqClB;AACD;AACA;AACM+B,eAAN,GAAoB;AAAA;;AAAA;AAChB,kBAAMvC,WAAW,OAAKC,GAAL,CAAS,UAAT,CAAjB;AACA,gBAAIG,SAAS,EAAb;AACAA,qBAAS,MAAM,OAAKC,KAAL,CAAW,OAAX,EAAoBC,cAApB,CAAmCN,QAAnC,CAAf;AACA,gBAAIO,YAAY,CAAhB;AACA,kBAAMiC,WAAW,MAAM,OAAKnC,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC7CC,yBAASC,MAAMC,MAD8B;AAE7CN,2BAAWA,SAFkC;AAG7CQ,8BAAc,CAAC,IAAD,EAAOX,MAAP;AAH+B,aAA1B,EAIpBqC,KAJoB,CAId,IAJc,CAAvB;AAKA,mBAAO,OAAKH,OAAL,CAAa;AAChBE,0BAAUA;AADM,aAAb,CAAP;AAVgB;AAanB;AACD;AACA;AACME,oBAAN,GAAyB;AAAA;;AAAA;AACrB,gBAAI/B,UAAUC,MAAMC,MAApB;AACA,gBAAI8B,QAAQ,MAAM,OAAKtC,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AACxCC,yBAASA,OAD+B;AAExCJ,2BAAW,CAF6B;AAGxCO,4BAAY,CAAC,GAAD,EAAM,CAAN,CAH4B;AAIxCC,8BAAc,CAAC,IAAD,EAAO,SAAP;AAJ0B,aAA1B,EAKf0B,KALe,CAKT,IALS,CAAlB;AAMA,gBAAIG,aAAa,MAAM,OAAKvC,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC7CC,yBAASA,OADoC;AAE7CJ,2BAAW,CAFkC;AAG7CO,4BAAY,CAAC,GAAD,EAAM,CAAN,CAHiC;AAI7CC,8BAAc;AAJ+B,aAA1B,EAKpB0B,KALoB,CAKd,IALc,CAAvB;AAMA,gBAAII,YAAY,MAAM,OAAKxC,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC5CC,yBAASA,OADmC;AAE5CG,4BAAY,CAAC,GAAD,EAAM,CAAN,CAFgC;AAG5CP,2BAAW,CAHiC;AAI5CQ,8BAAc;AAJ8B,aAA1B,EAKnB0B,KALmB,CAKb,IALa,CAAtB;AAMA,gBAAIK,YAAY;AACZH,uBAAOA,KADK;AAEZC,4BAAYA,UAFA;AAGZC,2BAAWA;AAHC,aAAhB;AAKA,mBAAO,OAAKP,OAAL,CAAaQ,SAAb,CAAP;AAzBqB;AA0BxB;AACKC,gBAAN,GAAqB;AAAA;;AAAA;AACjB,kBAAMC,UAAU,OAAK/C,GAAL,CAAS,SAAT,CAAhB;AACA,kBAAMgD,YAAY,MAAM,OAAK5C,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC9CC,yBAASC,MAAMC,MAD+B;AAE9CU,oBAAIyB;AAF0C,aAA1B,EAGrBE,IAHqB,EAAxB;AAIA,kBAAMC,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,gBAAI1C,MAAM2C,OAAN,CAAcN,SAAd,CAAJ,EAA8B;AAC1B,uBAAO,OAAKO,IAAL,CAAU,OAAV,CAAP;AACH;AACDP,sBAAUQ,aAAV,GAA0B,MAAM,OAAKpD,KAAL,CAAW,QAAX,EAAqBK,KAArB,CAA2B;AACvDa,oBAAI0B,UAAUS;AADyC,aAA3B,EAE7BC,QAF6B,CAEpB,MAFoB,EAEZ,IAFY,CAAhC;AAGAV,sBAAUW,SAAV,GAAsB,MAAM,OAAKvD,KAAL,CAAW,QAAX,EAAqBK,KAArB,CAA2B;AACnDa,oBAAI0B,UAAUY;AADqC,aAA3B,EAEzBF,QAFyB,CAEhB,MAFgB,EAER,IAFQ,CAA5B;AAGAV,sBAAUa,aAAV,GAA0B,MAAM,OAAKzD,KAAL,CAAW,QAAX,EAAqBK,KAArB,CAA2B;AACvDa,oBAAI0B,UAAUc;AADyC,aAA3B,EAE7BJ,QAF6B,CAEpB,MAFoB,EAEZ,IAFY,CAAhC;AAGAV,sBAAUe,WAAV,GAAwBf,UAAUQ,aAAV,GAA0BR,UAAUW,SAApC,GAAgDX,UAAUa,aAAlF;AACAb,sBAAUgB,UAAV,GAAuBC,OAAOC,IAAP,CAAYlB,UAAUgB,UAAtB,EAAkC,QAAlC,EAA4CG,QAA5C,EAAvB;AACA,kBAAMC,aAAa,MAAM,OAAKhE,KAAL,CAAW,aAAX,EAA0BK,KAA1B,CAAgC;AACrDC,yBAASC,MAAMC,MADsC;AAErDS,0BAAU0B,OAF2C;AAGrDzC,2BAAW;AAH0C,aAAhC,EAItBiB,MAJsB,EAAzB;AAKA,gBAAIC,aAAa,CAAjB;AACA,iBAAK,MAAM6C,KAAX,IAAoBD,UAApB,EAAgC;AAC5B5C,8BAAc6C,MAAM1C,MAApB;AACH;AACD;AACAqB,sBAAUhB,iBAAV,GAA8B,MAAM,OAAK5B,KAAL,CAAW,OAAX,EAAoB6B,kBAApB,CAAuCc,OAAvC,CAApC;AACA,gBAAIpC,MAAM2C,OAAN,CAAcN,UAAUsB,YAAxB,CAAJ,EAA2C;AACvCtB,0BAAUsB,YAAV,GAAyB,CAAzB;AACH,aAFD,MAEOtB,UAAUsB,YAAV,GAAyB9E,OAAOqC,IAAP,CAAYmB,UAAUsB,YAAtB,EAAoCvC,MAApC,CAA2C,qBAA3C,CAAzB;AACP,gBAAIpB,MAAM2C,OAAN,CAAcN,UAAUuB,aAAxB,CAAJ,EAA4C;AACxCvB,0BAAUuB,aAAV,GAA0B,CAA1B;AACH,aAFD,MAEOvB,UAAUuB,aAAV,GAA0B/E,OAAOqC,IAAP,CAAYmB,UAAUuB,aAAtB,EAAqCxC,MAArC,CAA4C,qBAA5C,CAA1B;AACP,gBAAIpB,MAAM2C,OAAN,CAAcN,UAAUwB,QAAxB,CAAJ,EAAuC;AACnCxB,0BAAUwB,QAAV,GAAqB,CAArB;AACH,aAFD,MAEOxB,UAAUwB,QAAV,GAAqBhF,OAAOqC,IAAP,CAAYmB,UAAUwB,QAAtB,EAAgCzC,MAAhC,CAAuC,qBAAvC,CAArB;AACP,gBAAIpB,MAAM2C,OAAN,CAAcN,UAAUyB,aAAxB,CAAJ,EAA4C;AACxCzB,0BAAUyB,aAAV,GAA0B,CAA1B;AACH,aAFD,MAEO;AACHzB,0BAAU0B,kBAAV,GAA+B1B,UAAUyB,aAAV,GAA0B,KAAK,EAAL,GAAU,EAAV,GAAe,EAAxE;AACAzB,0BAAUyB,aAAV,GAA0BjF,OAAOqC,IAAP,CAAYmB,UAAUyB,aAAtB,EAAqC1C,MAArC,CAA4C,qBAA5C,CAA1B;AACH;AACD;AACA,gBAAIiB,UAAUlC,YAAV,KAA2B,GAA3B,IAAkCkC,UAAUlC,YAAV,KAA2B,GAAjE,EAAsE;AAClE;AACAkC,0BAAU2B,cAAV,GAA2B3B,UAAUpB,QAAV,GAAqB,KAAK,EAAL,GAAU,EAA1D,CAFkE,CAEJ;AAC9D,oBAAIoB,UAAU2B,cAAV,GAA2BzB,WAA/B,EAA4C;AACxC;AACA,wBAAI0B,aAAa;AACb9D,sCAAc;AADD,qBAAjB;AAGA,0BAAM,OAAKV,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC5Ba,4BAAIyB;AADwB,qBAA1B,EAEH8B,MAFG,CAEID,UAFJ,CAAN;AAGH;AACJ;AACD5B,sBAAUpB,QAAV,GAAqBpC,OAAOqC,IAAP,CAAYmB,UAAUpB,QAAtB,EAAgCG,MAAhC,CAAuC,qBAAvC,CAArB;AACAiB,sBAAUlC,YAAV,GAAyB,EAAzB;AACA;AACA,kBAAMoB,eAAe,MAAM,OAAK9B,KAAL,CAAW,OAAX,EAAoB+B,oBAApB,CAAyCY,OAAzC,CAA3B;AACA,kBAAM+B,WAAW,MAAM,OAAK1E,KAAL,CAAW,OAAX,EAAoB2E,gBAApB,CAAqChC,OAArC,CAAvB;AACA,mBAAO,OAAKV,OAAL,CAAa;AAChBW,2BAAWA,SADK;AAEhBoB,4BAAYA,UAFI;AAGhBlC,8BAAcA,YAHE;AAIhB4C,0BAAUA,QAJM;AAKhBtD,4BAAYA;AALI,aAAb,CAAP;AAlEiB;AAyEpB;AACD;;;;AAIMwD,oBAAN,GAAyB;AAAA;;AAAA;AACrB,kBAAMjC,UAAU,OAAK/C,GAAL,CAAS,SAAT,CAAhB;AACA,gBAAI+C,UAAU,CAAd,EAAiB;AACb,sBAAMqB,aAAa,MAAM,OAAKhE,KAAL,CAAW,aAAX,EAA0BK,KAA1B,CAAgC;AACrDC,6BAASC,MAAMC,MADsC;AAErDS,8BAAU0B,OAF2C;AAGrDzC,+BAAW;AAH0C,iBAAhC,EAItBiB,MAJsB,EAAzB;AAKA,oBAAIC,aAAa,CAAjB;AACA,qBAAK,MAAM6C,KAAX,IAAoBD,UAApB,EAAgC;AAC5B5C,kCAAc6C,MAAM1C,MAApB;AACH;AACD,uBAAO,OAAKU,OAAL,CAAa+B,UAAb,CAAP;AACH,aAXD,MAWO;AACH,sBAAMa,WAAW,MAAM,OAAK7E,KAAL,CAAW,MAAX,EAAmBK,KAAnB,CAAyB;AAC5CC,6BAASC,MAAMC,MAD6B;AAE5CsE,6BAAQ,CAFoC;AAG5C5E,+BAAW,CAHiC;AAI5C6E,6BAAS;AAJmC,iBAAzB,EAKpB5D,MALoB,EAAvB;AAMA,uBAAO,OAAKc,OAAL,CAAa4C,QAAb,CAAP;AACH;AArBoB;AAsBxB;AACD;;;;AAIMG,gBAAN,GAAqB;AAAA;;AAAA;AACjB,kBAAMrC,UAAU,OAAKsC,IAAL,CAAU,SAAV,CAAhB;AACA;AACA,kBAAMnD,eAAe,MAAM,OAAK9B,KAAL,CAAW,OAAX,EAAoB+B,oBAApB,CAAyCY,OAAzC,CAA3B;AACA;AACA,gBAAI,CAACb,aAAaoD,MAAlB,EAA0B;AACtB,uBAAO,OAAK/B,IAAL,CAAU,QAAV,CAAP;AACH;AACD;AACA,gBAAIqB,aAAa;AACb9D,8BAAc;AADD,aAAjB;AAGA,gBAAIkC,YAAY,MAAM,OAAK5C,KAAL,CAAW,OAAX,EAAoBI,KAApB,CAA0B,YAA1B,EAAwCC,KAAxC,CAA8C;AAChEa,oBAAIyB,OAD4D;AAEhErC,yBAASC,MAAMC;AAFiD,aAA9C,EAGnBqC,IAHmB,EAAtB;AAIA;AACA,kBAAMsC,YAAY,MAAM,OAAKnF,KAAL,CAAW,aAAX,EAA0BK,KAA1B,CAAgC;AACpDY,0BAAU0B,OAD0C;AAEpDrC,yBAASC,MAAMC;AAFqC,aAAhC,EAGrBW,MAHqB,EAAxB;AAIA,iBAAK,MAAML,IAAX,IAAmBqE,SAAnB,EAA8B;AAC1B,oBAAIC,WAAWtE,KAAKsE,QAApB;AACA,oBAAIC,aAAavE,KAAKuE,UAAtB;AACA,oBAAI9D,SAAST,KAAKS,MAAlB;AACA,sBAAM,OAAKvB,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC5Ba,wBAAIkE;AADwB,iBAA1B,EAEHE,SAFG,CAEO,cAFP,EAEuB/D,MAFvB,CAAN;AAGA,sBAAM,OAAKvB,KAAL,CAAW,SAAX,EAAsBK,KAAtB,CAA4B;AAC9Ba,wBAAImE;AAD0B,iBAA5B,EAEHC,SAFG,CAEO,cAFP,EAEuB/D,MAFvB,CAAN;AAGH;AACD,kBAAMgE,aAAa,MAAM,OAAKvF,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC/Ca,oBAAIyB;AAD2C,aAA1B,EAEtB8B,MAFsB,CAEfD,UAFe,CAAzB;AAGA,mBAAO,OAAKvC,OAAL,CAAasD,UAAb,CAAP;AAnCiB;AAoCpB;AACD;;;;AAIMC,gBAAN,GAAqB;AAAA;;AAAA;AACjB,kBAAM7C,UAAU,OAAKsC,IAAL,CAAU,SAAV,CAAhB;AACA;AACA,kBAAMnD,eAAe,MAAM,OAAK9B,KAAL,CAAW,OAAX,EAAoB+B,oBAApB,CAAyCY,OAAzC,CAA3B;AACA,gBAAI,CAACb,aAAa2D,MAAlB,EAA0B;AACtB,uBAAO,OAAKtC,IAAL,CAAU,QAAV,CAAP;AACH;AACD,kBAAMoC,aAAa,MAAM,OAAKvF,KAAL,CAAW,OAAX,EAAoB0F,eAApB,CAAoC/C,OAApC,CAAzB;AACA,mBAAO,OAAKV,OAAL,CAAasD,UAAb,CAAP;AARiB;AASpB;AACD;;;;AAIMI,iBAAN,GAAsB;AAAA;;AAAA;AAClB,kBAAMhD,UAAU,OAAKsC,IAAL,CAAU,SAAV,CAAhB;AACA;AACA,kBAAMnD,eAAe,MAAM,OAAK9B,KAAL,CAAW,OAAX,EAAoB+B,oBAApB,CAAyCY,OAAzC,CAA3B;AACA,gBAAI,CAACb,aAAa8D,OAAlB,EAA2B;AACvB,uBAAO,OAAKzC,IAAL,CAAU,QAAV,CAAP;AACH;AACD;AACA,kBAAML,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,gBAAIuB,aAAa;AACb9D,8BAAc,GADD;AAEbwD,8BAAcpB;AAFD,aAAjB;AAIA,kBAAMyC,aAAa,MAAM,OAAKvF,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC/Ca,oBAAIyB;AAD2C,aAA1B,EAEtB8B,MAFsB,CAEfD,UAFe,CAAzB;AAGA,mBAAO,OAAKvC,OAAL,CAAasD,UAAb,CAAP;AAhBkB;AAiBrB;AACD;;;;AAIMM,kBAAN,GAAuB;AAAA;;AAAA;AACnB,kBAAMlD,UAAU,OAAK/C,GAAL,CAAS,SAAT,CAAhB;AACA;AACA,kBAAMkD,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,gBAAIuB,aAAa;AACb9D,8BAAc,GADD;AAEbyD,+BAAerB;AAFF,aAAjB;AAIA,kBAAMyC,aAAa,MAAM,OAAKvF,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC/Ca,oBAAIyB;AAD2C,aAA1B,EAEtB8B,MAFsB,CAEfD,UAFe,CAAzB;AAGA,mBAAO,OAAKvC,OAAL,CAAasD,UAAb,CAAP;AAXmB;AAYtB;AACD;;;;AAIMO,gBAAN,GAAqB;AAAA;;AAAA;AACjB;AACA,kBAAMC,YAAY,QAAKd,IAAL,CAAU,WAAV,CAAlB;AACA,kBAAMe,eAAe,QAAKf,IAAL,CAAU,cAAV,CAArB;AACA,kBAAMgB,aAAa,QAAKhB,IAAL,CAAU,YAAV,CAAnB;AACA,gBAAIrB,aAAa,QAAKqB,IAAL,CAAU,YAAV,CAAjB;AACA,kBAAMiB,SAASrC,OAAOC,IAAP,CAAYF,UAAZ,CAAf,CANiB,CAMuB;AACxC,kBAAMuC,iBAAiB,MAAM,QAAKnG,KAAL,CAAW,SAAX,EAAsBK,KAAtB,CAA4B;AACrDa,oBAAI6E;AADiD,aAA5B,EAE1BlD,IAF0B,EAA7B;AAGA,gBAAItC,MAAM2C,OAAN,CAAciD,cAAd,CAAJ,EAAmC;AAC/B,uBAAO,QAAKhD,IAAL,CAAU,SAAV,CAAP;AACH;AACD;AACA,kBAAMiD,mBAAmB,MAAM,QAAKpG,KAAL,CAAW,MAAX,EAAmBK,KAAnB,CAAyB;AACpDC,yBAASC,MAAMC,MADqC;AAEpDsE,yBAAS,CAF2C;AAGpD5E,2BAAW;AAHyC,aAAzB,EAI5BiB,MAJ4B,EAA/B;AAKA,gBAAIZ,MAAM2C,OAAN,CAAckD,gBAAd,CAAJ,EAAqC;AACjC,uBAAO,QAAKjD,IAAL,CAAU,OAAV,CAAP;AACH;AACD,gBAAIkD,aAAa,CAAjB;AACA,gBAAIC,aAAa,CAAjB;AACA,iBAAI,MAAMxF,IAAV,IAAkBsF,gBAAlB,EAAmC;AAC/B,oBAAIG,UAAU,MAAM,QAAKvG,KAAL,CAAW,SAAX,EAAsBK,KAAtB,CAA4B;AAC5Ca,wBAAGJ,KAAKuE;AADoC,iBAA5B,EAEjBxC,IAFiB,EAApB;AAGA,oBAAG/B,KAAKS,MAAL,GAAcgF,QAAQC,YAAzB,EAAsC;AAClCF;AACH;AACD,oBAAGxF,KAAK2F,YAAL,IAAqB3F,KAAK4F,SAA7B,EAAuC;AACnCL;AACH;AACJ;AACD,gBAAGC,aAAa,CAAhB,EAAkB;AACd,uBAAO,QAAKnD,IAAL,CAAU,GAAV,EAAe,YAAf,CAAP;AACH;AACD,gBAAGkD,aAAa,CAAhB,EAAkB;AACd,uBAAO,QAAKlD,IAAL,CAAU,GAAV,EAAe,cAAf,CAAP;AACH;AACD;AACA;AACA;AACA,gBAAIwD,kBAAkB,IAAtB;AACA,iBAAK,MAAMC,QAAX,IAAuBR,gBAAvB,EAAyC;AACrCO,mCAAmBC,SAASrF,MAAT,GAAkBqF,SAASH,YAA9C;AACH;AACD;AACA,kBAAMI,kBAAkBF,kBAAkBX,YAA1C,CAjDiB,CAiDuC;AACxD,kBAAMc,cAAcD,kBAAkB,IAAtC,CAlDiB,CAkD2B;AAC5C,kBAAM/D,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,gBAAI8D,aAAa,EAAjB;AACA,iBAAK,MAAMjG,IAAX,IAAmBsF,gBAAnB,EAAqC;AACjC,oBAAIY,IAAIC,OAAOnG,IAAP,IAAe,CAAvB;AACAiG,6BAAaA,aAAaC,CAAb,GAAiB,GAAjB,GAAuBZ,iBAAiBtF,IAAjB,EAAuBoG,SAA9C,GAA0D,GAA1D,GAAgEd,iBAAiBtF,IAAjB,EAAuBS,MAAvF,GAAgG,IAA7G;AACH;AACD,gBAAI4F,MAAM,MAAM,QAAKnH,KAAL,CAAW,UAAX,EAAuBK,KAAvB,CAA6B;AACzCa,oBAAI;AADqC,aAA7B,EAEb2B,IAFa,EAAhB;AAGA,gBAAIuE,cAAcD,IAAIE,IAAtB;AACA,gBAAIC,gBAAgBH,IAAII,GAAxB;AACA;AACA,gBAAIC,WAAW,MAAM,QAAKxH,KAAL,CAAW,MAAX,EAAmBK,KAAnB,CAAyB;AAC1Ca,oBAAIX,MAAMC;AADgC,aAAzB,EAElBqC,IAFkB,EAArB;AAGA;AACA,kBAAMD,YAAY;AACd6E,0BAAU,QAAKzH,KAAL,CAAW,OAAX,EAAoB0H,mBAApB,EADI;AAEdpH,yBAASC,MAAMC,MAFD;AAGd;AACAmH,2BAAWxB,eAAeyB,IAJZ;AAKdC,wBAAQ1B,eAAe0B,MALT;AAMdxE,0BAAU8C,eAAe2B,WANX;AAOdtE,sBAAM2C,eAAe4B,OAPP;AAQdrE,0BAAUyC,eAAe6B,WARX;AASdC,yBAAS9B,eAAe8B,OATV;AAUdvH,8BAAc,GAVA,EAUK;AACnB;AACAwH,+BAAelC,YAZD;AAadpC,4BAAYsC,OAAOnC,QAAP,CAAgB,QAAhB,CAbE;AAcdvC,0BAAUsB,WAdI;AAedqF,6BAAaxB,eAfC;AAgBdyB,6BAAavB,eAhBC;AAiBdwB,8BAAcvB,WAjBA;AAkBdwB,8BAAcxB,WAlBA;AAmBdC,4BAAYA,UAnBE;AAoBdwB,6BAAYtC;AApBE,aAAlB;AAsBA;AACA,kBAAMtD,UAAU,MAAM,QAAK3C,KAAL,CAAW,OAAX,EAAoBwI,GAApB,CAAwB5F,SAAxB,CAAtB;AACAA,sBAAU1B,EAAV,GAAeyB,OAAf;AACA,gBAAI,CAACA,OAAL,EAAc;AACV,uBAAO,QAAKQ,IAAL,CAAU,QAAV,CAAP;AACH;AACD;AACA,kBAAMsF,iBAAiB,EAAvB;AACA,iBAAK,MAAMC,SAAX,IAAwBtC,gBAAxB,EAA0C;AACtCqC,+BAAezG,IAAf,CAAoB;AAChB1B,6BAASC,MAAMC,MADC;AAEhBS,8BAAU0B,OAFM;AAGhByC,8BAAUsD,UAAUtD,QAHJ;AAIhBC,gCAAYqD,UAAUrD,UAJN;AAKhBsD,gCAAYD,UAAUC,UALN;AAMhBzB,+BAAWwB,UAAUxB,SANL;AAOhB0B,kCAAcF,UAAUE,YAPR;AAQhBnC,kCAAciC,UAAUjC,YARR;AAShBlF,4BAAQmH,UAAUnH,MATF;AAUhBsH,kDAA8BH,UAAUG,4BAVxB;AAWhBC,2CAAuBJ,UAAUI;AAXjB,iBAApB;AAaH;AACD,kBAAM,QAAK9I,KAAL,CAAW,aAAX,EAA0B+I,OAA1B,CAAkCN,cAAlC,CAAN;AACA,kBAAM,QAAKzI,KAAL,CAAW,MAAX,EAAmBgJ,aAAnB,EAAN;AACA,mBAAO,QAAK/G,OAAL,CAAa;AAChBW,2BAAWA;AADK,aAAb,CAAP;AAlHiB;AAqHpB;AACKqG,gBAAN,GAAqB;AAAA;;AAAA;AACjB,kBAAMlD,YAAY,QAAKd,IAAL,CAAU,WAAV,CAAlB;AACA,kBAAMtC,UAAU,QAAKsC,IAAL,CAAU,SAAV,CAAhB;AACA;AACA;AACA;AACA,kBAAMiE,gBAAgB,MAAM,QAAKlJ,KAAL,CAAW,SAAX,EAAsBK,KAAtB,CAA4B;AACpDa,oBAAI6E;AADgD,aAA5B,EAEzBlD,IAFyB,EAA5B;AAGA,kBAAMC,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,kBAAML,YAAY;AACd;AACA+E,2BAAWuB,cAActB,IAFX;AAGdC,wBAAQqB,cAAcrB,MAHR;AAIdxE,0BAAU6F,cAAcpB,WAJV;AAKdtE,sBAAM0F,cAAcnB,OALN;AAMdrE,0BAAUwF,cAAclB,WANV;AAOdC,yBAASiB,cAAcjB;AACvB;AACA;AACA;AACA;AACA;AAZc,aAAlB;AAcA,kBAAMzD,aAAa,MAAM,QAAKxE,KAAL,CAAW,OAAX,EAAoBK,KAApB,CAA0B;AAC/Ca,oBAAIyB;AAD2C,aAA1B,EAEtB8B,MAFsB,CAEf7B,SAFe,CAAzB;AAGA,mBAAO,QAAKX,OAAL,CAAauC,UAAb,CAAP;AA3BiB;AA4BpB;AACD;;;;AAIM2E,iBAAN,GAAsB;AAAA;;AAAA;AAClB;AACA,kBAAMrG,cAAcC,SAAS,IAAIC,IAAJ,GAAWC,OAAX,KAAuB,IAAhC,CAApB;AACA,kBAAMN,UAAU,QAAK/C,GAAL,CAAS,SAAT,CAAhB;AACA,gBAAIwJ,OAAO,MAAM,QAAKpJ,KAAL,CAAW,eAAX,EAA4BK,KAA5B,CAAkC;AAC/CY,0BAAU0B;AADqC,aAAlC,EAEdE,IAFc,EAAjB;AAGA,gBAAItC,MAAM2C,OAAN,CAAckG,IAAd,CAAJ,EAAyB;AACrB,uBAAO,QAAKjG,IAAL,CAAU,GAAV,EAAe,QAAf,CAAP;AACH;AACD,kBAAMkG,cAAc,MAAM,QAAKrJ,KAAL,CAAW,eAAX,EAA4BK,KAA5B,CAAkC;AACxDY,0BAAU0B;AAD8C,aAAlC,EAEvBE,IAFuB,EAA1B;AAGA;AACA,gBAAIyG,aAAaF,KAAKG,WAAtB;AACA,gBAAIC,MAAM,CAAC1G,cAAcwG,UAAf,IAA6B,EAAvC;AACA,gBAAIG,YAAYL,KAAKK,SAArB;AACA,gBAAIA,aAAa,CAAjB,EAAoB;AAChB,uBAAO,QAAKxH,OAAL,CAAaoH,WAAb,CAAP;AACH,aAFD,MAEO,IAAIC,cAAc,CAAd,IAAmBE,MAAM,EAA7B,EAAiC;AACpC,uBAAO,QAAKvH,OAAL,CAAaoH,WAAb,CAAP;AACH,aAFM,MAEA;AACH,oBAAIK,cAAcL,YAAYM,YAA9B;AACA,oBAAIC,YAAYP,YAAYQ,aAA5B;AACA,oBAAIC,OAAOJ,YAAYK,SAAZ,CAAsB,CAAtB,EAAyB,CAAzB,CAAX;AACA,oBAAIC,cAAc,EAAlB;AACA,oBAAIF,QAAQ,IAAZ,EAAkB;AACdE,kCAAc,WAAd;AACAJ,gCAAYA,YAAY,OAAxB;AACH,iBAHD,MAGO;AACHI,kCAAcN,WAAd;AACH;AACD,oBAAIO,kBAAkB,MAAM,QAAKC,cAAL,CAAoBF,WAApB,EAAiCJ,SAAjC,CAA5B;AACA,oBAAIO,iBAAiBF,gBAAgBE,cAArC;AACA,oBAAIC,gBAAgBH,gBAAgBX,UAApC;AACAc,gCAAgBrH,SAAS,IAAIC,IAAJ,CAASoH,aAAT,EAAwBnH,OAAxB,KAAoC,IAA7C,CAAhB;AACAkH,iCAAiB,MAAM,QAAKE,iBAAL,CAAuBF,cAAvB,CAAvB;AACA,oBAAIG,SAASL,gBAAgBK,MAA7B;AACA,oBAAIC,SAASN,gBAAgBO,IAA7B;AACAD,yBAASE,KAAKC,SAAL,CAAeH,MAAf,CAAT;AACA,oBAAII,WAAW;AACXC,oCAAgBT,cADL;AAEXV,+BAAWa,MAFA;AAGXC,4BAAQA,MAHG;AAIXhB,iCAAaa;AAJF,iBAAf;AAMA,sBAAM,QAAKpK,KAAL,CAAW,eAAX,EAA4BK,KAA5B,CAAkC;AACpCY,8BAAU0B;AAD0B,iBAAlC,EAEH8B,MAFG,CAEIkG,QAFJ,CAAN;AAGA,oBAAIE,UAAU,MAAM,QAAK7K,KAAL,CAAW,eAAX,EAA4BK,KAA5B,CAAkC;AAClDY,8BAAU0B;AADwC,iBAAlC,EAEjBE,IAFiB,EAApB;AAGA,uBAAO,QAAKZ,OAAL,CAAa4I,OAAb,CAAP;AACH;AACD;AAtDkB;AAuDrB;AACKX,kBAAN,CAAqBF,WAArB,EAAkCJ,SAAlC,EAA6C;AAAA;AACzC,kBAAMkB,UAAU;AACZC,wBAAQ,KADI;AAEZC,qBAAK,gDAAgDpB,SAAhD,GAA4D,QAA5D,GAAuEI,WAFhE;AAGZiB,yBAAS;AACL,oCAAgB,iCADX;AAEL;AACA,qCAAiB;AAHZ;AAHG,aAAhB;AASA,gBAAIC,cAAc,MAAM7L,GAAGyL,OAAH,CAAxB;AACAI,0BAAcT,KAAKU,KAAL,CAAWD,WAAX,CAAd;AACA,mBAAOA,YAAYE,MAAnB;AAZyC;AAa5C;AACKf,qBAAN,CAAwBtK,MAAxB,EAAgC;AAAA;AAC5B,gBAAIA,UAAU,CAAd,EAAiB;AACb,uBAAO,UAAP;AACH,aAFD,MAEO,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,KAAP;AACH,aAFM,MAEA,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,MAAP;AACH,aAFM,MAEA,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,KAAP;AACH,aAFM,MAEA,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,oCAAP;AACH,aAFM,MAEA,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,wCAAP;AACH,aAFM,MAEA,IAAIA,UAAU,CAAd,EAAiB;AACpB,uBAAO,MAAP;AACH;AAf2B;AAgB/B;AACKsL,wBAAN,GAA6B;AAAA;AACzB,kBAAMP,UAAU;AACZC,wBAAQ,KADI;AAEZC,qBAAK,6EAFO;AAGZC,yBAAS;AACL,oCAAgB,iCADX;AAEL,qCAAiB;AAFZ;AAHG,aAAhB;AAQA,gBAAIC,cAAc,MAAM7L,GAAGyL,OAAH,CAAxB;AACAI,0BAAcT,KAAKU,KAAL,CAAWD,WAAX,CAAd;AAVyB;AAW5B;AAxhB+B,CAApC",
    "file": "../../../src/api/controller/order.js",
    "sourcesContent": [
        "const Base = require('./base.js');\nconst moment = require('moment');\nconst rp = require('request-promise');\nconst fs = require('fs');\nconst http = require(\"http\");\nmodule.exports = class extends Base {\n    /**\n     * 获取订单列表\n     * @return {Promise} []\n     */\n    async listAction() {\n        const showType = this.get('showType');\n        const page = this.get('page');\n        const size = this.get('size');\n        let status = [];\n        status = await this.model('order').getOrderStatus(showType);\n        let is_delete = 0;\n        // const orderList = await this.model('order').where({ user_id: think.userId }).page(1, 10).order('add_time DESC').countSelect();\n        const orderList = await this.model('order').field('id,add_time,actual_price,freight_price,offline_pay').where({\n            user_id: think.userId,\n            is_delete: is_delete,\n            order_type: ['<', 7],\n            order_status: ['IN', status]\n        }).page(page, size).order('add_time DESC').countSelect();\n        const newOrderList = [];\n        for (const item of orderList.data) {\n            // 订单的商品\n            item.goodsList = await this.model('order_goods').field('id,list_pic_url,number').where({\n                user_id: think.userId,\n                order_id: item.id,\n                is_delete: 0\n            }).select();\n            item.goodsCount = 0;\n            item.goodsList.forEach(v => {\n                item.goodsCount += v.number;\n            });\n            item.add_time = moment.unix(await this.model('order').getOrderAddTime(item.id)).format('YYYY-MM-DD HH:mm:ss');\n            // item.dealdone_time = moment.unix(await this.model('order').getOrderAddTime(item.id)).format('YYYY-MM-DD HH:mm:ss');\n            // item.add_time =this.timestampToTime(await this.model('order').getOrderAddTime(item.id));\n            // 订单状态的处理\n            item.order_status_text = await this.model('order').getOrderStatusText(item.id);\n            // 可操作的选项\n            item.handleOption = await this.model('order').getOrderHandleOption(item.id);\n            newOrderList.push(item);\n        }\n        orderList.data = newOrderList;\n        return this.success(orderList);\n    }\n    // 获得订单数量\n    //\n    async countAction() {\n        const showType = this.get('showType');\n        let status = [];\n        status = await this.model('order').getOrderStatus(showType);\n        let is_delete = 0;\n        const allCount = await this.model('order').where({\n            user_id: think.userId,\n            is_delete: is_delete,\n            order_status: ['IN', status]\n        }).count('id');\n        return this.success({\n            allCount: allCount,\n        });\n    }\n    // 获得订单数量状态\n    //\n    async orderCountAction() {\n        let user_id = think.userId;\n        let toPay = await this.model('order').where({\n            user_id: user_id,\n            is_delete: 0,\n            order_type: ['<', 7],\n            order_status: ['IN', '101,801']\n        }).count('id');\n        let toDelivery = await this.model('order').where({\n            user_id: user_id,\n            is_delete: 0,\n            order_type: ['<', 7],\n            order_status: 300\n        }).count('id');\n        let toReceive = await this.model('order').where({\n            user_id: user_id,\n            order_type: ['<', 7],\n            is_delete: 0,\n            order_status: 301\n        }).count('id');\n        let newStatus = {\n            toPay: toPay,\n            toDelivery: toDelivery,\n            toReceive: toReceive,\n        }\n        return this.success(newStatus);\n    }\n    async detailAction() {\n        const orderId = this.get('orderId');\n        const orderInfo = await this.model('order').where({\n            user_id: think.userId,\n            id: orderId\n        }).find();\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        if (think.isEmpty(orderInfo)) {\n            return this.fail('订单不存在');\n        }\n        orderInfo.province_name = await this.model('region').where({\n            id: orderInfo.province\n        }).getField('name', true);\n        orderInfo.city_name = await this.model('region').where({\n            id: orderInfo.city\n        }).getField('name', true);\n        orderInfo.district_name = await this.model('region').where({\n            id: orderInfo.district\n        }).getField('name', true);\n        orderInfo.full_region = orderInfo.province_name + orderInfo.city_name + orderInfo.district_name;\n        orderInfo.postscript = Buffer.from(orderInfo.postscript, 'base64').toString();\n        const orderGoods = await this.model('order_goods').where({\n            user_id: think.userId,\n            order_id: orderId,\n            is_delete: 0\n        }).select();\n        var goodsCount = 0;\n        for (const gitem of orderGoods) {\n            goodsCount += gitem.number;\n        }\n        // 订单状态的处理\n        orderInfo.order_status_text = await this.model('order').getOrderStatusText(orderId);\n        if (think.isEmpty(orderInfo.confirm_time)) {\n            orderInfo.confirm_time = 0;\n        } else orderInfo.confirm_time = moment.unix(orderInfo.confirm_time).format('YYYY-MM-DD HH:mm:ss');\n        if (think.isEmpty(orderInfo.dealdone_time)) {\n            orderInfo.dealdone_time = 0;\n        } else orderInfo.dealdone_time = moment.unix(orderInfo.dealdone_time).format('YYYY-MM-DD HH:mm:ss');\n        if (think.isEmpty(orderInfo.pay_time)) {\n            orderInfo.pay_time = 0;\n        } else orderInfo.pay_time = moment.unix(orderInfo.pay_time).format('YYYY-MM-DD HH:mm:ss');\n        if (think.isEmpty(orderInfo.shipping_time)) {\n            orderInfo.shipping_time = 0;\n        } else {\n            orderInfo.confirm_remainTime = orderInfo.shipping_time + 10 * 24 * 60 * 60;\n            orderInfo.shipping_time = moment.unix(orderInfo.shipping_time).format('YYYY-MM-DD HH:mm:ss');\n        }\n        // 订单支付倒计时\n        if (orderInfo.order_status === 101 || orderInfo.order_status === 801) {\n            // if (moment().subtract(60, 'minutes') < moment(orderInfo.add_time)) {\n            orderInfo.final_pay_time = orderInfo.add_time + 24 * 60 * 60; //支付倒计时2小时\n            if (orderInfo.final_pay_time < currentTime) {\n                //超过时间不支付，更新订单状态为取消\n                let updateInfo = {\n                    order_status: 102\n                };\n                await this.model('order').where({\n                    id: orderId\n                }).update(updateInfo);\n            }\n        }\n        orderInfo.add_time = moment.unix(orderInfo.add_time).format('YYYY-MM-DD HH:mm:ss');\n        orderInfo.order_status = '';\n        // 订单可操作的选择,删除，支付，收货，评论，退换货\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\n        const textCode = await this.model('order').getOrderTextCode(orderId);\n        return this.success({\n            orderInfo: orderInfo,\n            orderGoods: orderGoods,\n            handleOption: handleOption,\n            textCode: textCode,\n            goodsCount: goodsCount,\n        });\n    }\n    /**\n     * order 和 order-check 的goodslist\n     * @return {Promise} []\n     */\n    async orderGoodsAction() {\n        const orderId = this.get('orderId');\n        if (orderId > 0) {\n            const orderGoods = await this.model('order_goods').where({\n                user_id: think.userId,\n                order_id: orderId,\n                is_delete: 0\n            }).select();\n            var goodsCount = 0;\n            for (const gitem of orderGoods) {\n                goodsCount += gitem.number;\n            }\n            return this.success(orderGoods);\n        } else {\n            const cartList = await this.model('cart').where({\n                user_id: think.userId,\n                checked:1,\n                is_delete: 0,\n                is_fast: 0,\n            }).select();\n            return this.success(cartList);\n        }\n    }\n    /**\n     * 取消订单\n     * @return {Promise} []\n     */\n    async cancelAction() {\n        const orderId = this.post('orderId');\n        // 检测是否能够取消\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\n        // console.log('--------------' + handleOption.cancel);\n        if (!handleOption.cancel) {\n            return this.fail('订单不能取消');\n        }\n        // 设置订单已取消状态\n        let updateInfo = {\n            order_status: 102\n        };\n        let orderInfo = await this.model('order').field('order_type').where({\n            id: orderId,\n            user_id: think.userId\n        }).find();\n        //取消订单，还原库存\n        const goodsInfo = await this.model('order_goods').where({\n            order_id: orderId,\n            user_id: think.userId\n        }).select();\n        for (const item of goodsInfo) {\n            let goods_id = item.goods_id;\n            let product_id = item.product_id;\n            let number = item.number;\n            await this.model('goods').where({\n                id: goods_id\n            }).increment('goods_number', number);\n            await this.model('product').where({\n                id: product_id\n            }).increment('goods_number', number);\n        }\n        const succesInfo = await this.model('order').where({\n            id: orderId\n        }).update(updateInfo);\n        return this.success(succesInfo);\n    }\n    /**\n     * 删除订单\n     * @return {Promise} []\n     */\n    async deleteAction() {\n        const orderId = this.post('orderId');\n        // 检测是否能够取消\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\n        if (!handleOption.delete) {\n            return this.fail('订单不能删除');\n        }\n        const succesInfo = await this.model('order').orderDeleteById(orderId);\n        return this.success(succesInfo);\n    }\n    /**\n     * 确认订单\n     * @return {Promise} []\n     */\n    async confirmAction() {\n        const orderId = this.post('orderId');\n        // 检测是否能够取消\n        const handleOption = await this.model('order').getOrderHandleOption(orderId);\n        if (!handleOption.confirm) {\n            return this.fail('订单不能确认');\n        }\n        // 设置订单已取消状态\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        let updateInfo = {\n            order_status: 401,\n            confirm_time: currentTime\n        };\n        const succesInfo = await this.model('order').where({\n            id: orderId\n        }).update(updateInfo);\n        return this.success(succesInfo);\n    }\n    /**\n     * 完成评论后的订单\n     * @return {Promise} []\n     */\n    async completeAction() {\n        const orderId = this.get('orderId');\n        // 设置订单已完成\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        let updateInfo = {\n            order_status: 401,\n            dealdone_time: currentTime\n        };\n        const succesInfo = await this.model('order').where({\n            id: orderId\n        }).update(updateInfo);\n        return this.success(succesInfo);\n    }\n    /**\n     * 提交订单\n     * @returns {Promise.<void>}\n     */\n    async submitAction() {\n        // 获取收货地址信息和计算运费\n        const addressId = this.post('addressId');\n        const freightPrice = this.post('freightPrice');\n        const offlinePay = this.post('offlinePay');\n        let postscript = this.post('postscript');\n        const buffer = Buffer.from(postscript); // 留言\n        const checkedAddress = await this.model('address').where({\n            id: addressId\n        }).find();\n        if (think.isEmpty(checkedAddress)) {\n            return this.fail('请选择收货地址');\n        }\n        // 获取要购买的商品\n        const checkedGoodsList = await this.model('cart').where({\n            user_id: think.userId,\n            checked: 1,\n            is_delete: 0\n        }).select();\n        if (think.isEmpty(checkedGoodsList)) {\n            return this.fail('请选择商品');\n        }\n        let checkPrice = 0;\n        let checkStock = 0;\n        for(const item of checkedGoodsList){\n            let product = await this.model('product').where({\n                id:item.product_id\n            }).find();\n            if(item.number > product.goods_number){\n                checkStock++;\n            }\n            if(item.retail_price != item.add_price){\n                checkPrice++;\n            }\n        }\n        if(checkStock > 0){\n            return this.fail(400, '库存不足，请重新下单');\n        }\n        if(checkPrice > 0){\n            return this.fail(400, '价格发生变化，请重新下单');\n        }\n        // 获取订单使用的红包\n        // 如果有用红包，则将红包的数量减少，当减到0时，将该条红包删除\n        // 统计商品总价\n        let goodsTotalPrice = 0.00;\n        for (const cartItem of checkedGoodsList) {\n            goodsTotalPrice += cartItem.number * cartItem.retail_price;\n        }\n        // 订单价格计算\n        const orderTotalPrice = goodsTotalPrice + freightPrice; // 订单的总价\n        const actualPrice = orderTotalPrice - 0.00; // 减去其它支付的金额后，要实际支付的金额 比如满减等优惠\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        let print_info = '';\n        for (const item in checkedGoodsList) {\n            let i = Number(item) + 1;\n            print_info = print_info + i + '、' + checkedGoodsList[item].goods_aka + '【' + checkedGoodsList[item].number + '】 ';\n        }\n        let def = await this.model('settings').where({\n            id: 1\n        }).find();\n        let sender_name = def.Name;\n        let sender_mobile = def.Tel;\n        // let sender_address = '';\n        let userInfo = await this.model('user').where({\n            id: think.userId\n        }).find();\n        // const checkedAddress = await this.model('address').where({id: addressId}).find();\n        const orderInfo = {\n            order_sn: this.model('order').generateOrderNumber(),\n            user_id: think.userId,\n            // 收货地址和运费\n            consignee: checkedAddress.name,\n            mobile: checkedAddress.mobile,\n            province: checkedAddress.province_id,\n            city: checkedAddress.city_id,\n            district: checkedAddress.district_id,\n            address: checkedAddress.address,\n            order_status: 101, // 订单初始状态为 101\n            // 根据城市得到运费，这里需要建立表：所在城市的具体运费\n            freight_price: freightPrice,\n            postscript: buffer.toString('base64'),\n            add_time: currentTime,\n            goods_price: goodsTotalPrice,\n            order_price: orderTotalPrice,\n            actual_price: actualPrice,\n            change_price: actualPrice,\n            print_info: print_info,\n            offline_pay:offlinePay\n        };\n        // 开启事务，插入订单信息和订单商品\n        const orderId = await this.model('order').add(orderInfo);\n        orderInfo.id = orderId;\n        if (!orderId) {\n            return this.fail('订单提交失败');\n        }\n        // 将商品信息录入数据库\n        const orderGoodsData = [];\n        for (const goodsItem of checkedGoodsList) {\n            orderGoodsData.push({\n                user_id: think.userId,\n                order_id: orderId,\n                goods_id: goodsItem.goods_id,\n                product_id: goodsItem.product_id,\n                goods_name: goodsItem.goods_name,\n                goods_aka: goodsItem.goods_aka,\n                list_pic_url: goodsItem.list_pic_url,\n                retail_price: goodsItem.retail_price,\n                number: goodsItem.number,\n                goods_specifition_name_value: goodsItem.goods_specifition_name_value,\n                goods_specifition_ids: goodsItem.goods_specifition_ids\n            });\n        }\n        await this.model('order_goods').addMany(orderGoodsData);\n        await this.model('cart').clearBuyGoods();\n        return this.success({\n            orderInfo: orderInfo\n        });\n    }\n    async updateAction() {\n        const addressId = this.post('addressId');\n        const orderId = this.post('orderId');\n        // 备注\n        // let postscript = this.post('postscript');\n        // const buffer = Buffer.from(postscript);\n        const updateAddress = await this.model('address').where({\n            id: addressId\n        }).find();\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        const orderInfo = {\n            // 收货地址和运费\n            consignee: updateAddress.name,\n            mobile: updateAddress.mobile,\n            province: updateAddress.province_id,\n            city: updateAddress.city_id,\n            district: updateAddress.district_id,\n            address: updateAddress.address,\n            // TODO 根据地址计算运费\n            // freight_price: 0.00,\n            // 备注\n            // postscript: buffer.toString('base64'),\n            // add_time: currentTime\n        };\n        const updateInfo = await this.model('order').where({\n            id: orderId\n        }).update(orderInfo);\n        return this.success(updateInfo);\n    }\n    /**\n     * 查询物流信息asd\n     * @returns {Promise.<void>}\n     */\n    async expressAction() {\n        // let aliexpress = think.config('aliexpress');\n        const currentTime = parseInt(new Date().getTime() / 1000);\n        const orderId = this.get('orderId');\n        let info = await this.model('order_express').where({\n            order_id: orderId\n        }).find();\n        if (think.isEmpty(info)) {\n            return this.fail(400, '暂无物流信息');\n        }\n        const expressInfo = await this.model('order_express').where({\n            order_id: orderId\n        }).find();\n        // 如果is_finish == 1；或者 updateTime 小于 10分钟，\n        let updateTime = info.update_time;\n        let com = (currentTime - updateTime) / 60;\n        let is_finish = info.is_finish;\n        if (is_finish == 1) {\n            return this.success(expressInfo);\n        } else if (updateTime != 0 && com < 20) {\n            return this.success(expressInfo);\n        } else {\n            let shipperCode = expressInfo.shipper_code;\n            let expressNo = expressInfo.logistic_code;\n            let code = shipperCode.substring(0, 2);\n            let shipperName = '';\n            if (code == \"SF\") {\n                shipperName = \"SFEXPRESS\";\n                expressNo = expressNo + ':0580';\n            } else {\n                shipperName = shipperCode;\n            }\n            let lastExpressInfo = await this.getExpressInfo(shipperName, expressNo);\n            let deliverystatus = lastExpressInfo.deliverystatus;\n            let newUpdateTime = lastExpressInfo.updateTime;\n            newUpdateTime = parseInt(new Date(newUpdateTime).getTime() / 1000);\n            deliverystatus = await this.getDeliverystatus(deliverystatus);\n            let issign = lastExpressInfo.issign;\n            let traces = lastExpressInfo.list;\n            traces = JSON.stringify(traces);\n            let dataInfo = {\n                express_status: deliverystatus,\n                is_finish: issign,\n                traces: traces,\n                update_time: newUpdateTime\n            }\n            await this.model('order_express').where({\n                order_id: orderId\n            }).update(dataInfo);\n            let express = await this.model('order_express').where({\n                order_id: orderId\n            }).find();\n            return this.success(express);\n        }\n        // return this.success(latestExpressInfo);\n    }\n    async getExpressInfo(shipperName, expressNo) {\n        const options = {\n            method: 'GET',\n            url: 'http://wuliu.market.alicloudapi.com/kdi?no=' + expressNo + '&type=' + shipperName,\n            headers: {\n                \"Content-Type\": \"application/json; charset=utf-8\",\n                // \"Authorization\": \"APPCODE f85be5270caf40c7a784ce3682fc4c8e\"\n                \"Authorization\": \"APPCODE 9d78e3dcbc7c48ef9d0e6e7b1bac46b8\"\n            }\n        };\n        let sessionData = await rp(options);\n        sessionData = JSON.parse(sessionData);\n        return sessionData.result;\n    }\n    async getDeliverystatus(status) {\n        if (status == 0) {\n            return '快递收件(揽件)';\n        } else if (status == 1) {\n            return '在途中';\n        } else if (status == 2) {\n            return '正在派件';\n        } else if (status == 3) {\n            return '已签收';\n        } else if (status == 4) {\n            return '派送失败(无法联系到收件人或客户要求择日派送，地址不详或手机号不清)';\n        } else if (status == 5) {\n            return '疑难件(收件人拒绝签收，地址有误或不能送达派送区域，收费等原因无法正常派送)';\n        } else if (status == 6) {\n            return '退件签收';\n        }\n    }\n    async getExpressInfoAction() {\n        const options = {\n            method: 'GET',\n            url: 'http://wuliu.market.alicloudapi.com/kdi?no=235078392411:0580&type=SFEXPRESS',\n            headers: {\n                \"Content-Type\": \"application/json; charset=utf-8\",\n                \"Authorization\": \"APPCODE 9d78e3dcbc7c48ef9d0e6e7b1bac46b8\"\n            }\n        };\n        let sessionData = await rp(options);\n        sessionData = JSON.parse(sessionData);\n    }\n};"
    ]
}